@page "/server/{id}"
@using Microsoft.AspNetCore.SignalR.Client
@using PlanningPoker.Client.Storage
@using PlanningPoker.Core.Models
@using PlanningPoker.Shared
@using PlanningPoker.Shared.ViewModels
@inject NavigationManager NavigationManager
@inject IServerSessionManager sessionManager

@if (CurrentServer != null && _currentPlayer != null)
{
    <SessionControlComponent @bind-Id="Id" @bind-Session="CurrentServer.CurrentSession" @bind-CurrentPlayer="_currentPlayer" @bind-HubConnection="_hubConnection" />
    <SessionRenderingComponent @bind-Id="Id" @bind-Server="CurrentServer" @bind-CurrentPlayer="_currentPlayer" @bind-HubConnection="_hubConnection" />
    <LogComponent @bind-HubConnection="_hubConnection" />
}

@if (_currentPlayer == null)
{
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <p>
                        Pick a username, and begin planning!
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>
                            Username
                            <input @bind-value="_username"
                                   @bind-value:event="oninput"
                                   size="20"
                                   class="form-control" />
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            Participation type
                            <select @bind="@_type"
                                    class="custom-select">
                                <option value="@PlayerType.Participant">Participant</option>
                                <option value="@PlayerType.Observer">Observer</option>
                            </select>
                        </label>
                    </div>
                    <div class="form-group">
                        <button @onclick="Join" disabled="@(string.IsNullOrWhiteSpace(_username))" class="btn btn-primary">Join</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private HubConnection _hubConnection;

    private string? _username;

    private PlayerType _type = PlayerType.Participant;

    private PlayerViewModel? _currentPlayer;

    public PokerServerViewModel? CurrentServer { get; set; }

    [Parameter]
    public string Id { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // Try get session from session storage, to see if the user should simply reconnect.
        var sessionExists = sessionManager.TryGetSession(Id, out var savedSession);
        if (sessionExists)
        {
            _username = savedSession.Username;
            Join();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/poker"))
            .Build();

        _hubConnection.On<PokerServerViewModel>(Messages.UPDATED, newServer =>
        {
            CurrentServer = newServer;
            StateHasChanged();
        });

        _hubConnection.On<PlayerViewModel>(Messages.KICKED, kickedPlayer =>
        {
            if (kickedPlayer.PublicId != _currentPlayer.PublicId) return;

            sessionManager.RemoveSession(Id);
            CurrentServer = null;
            _currentPlayer = null;
            StateHasChanged();
        });

        await _hubConnection.StartAsync();
    }

    async Task Join()
    {
        await _hubConnection.SendAsync("Connect", Id);
        _currentPlayer = await _hubConnection.InvokeAsync<PlayerViewModel>("Join", Id, _username, _type);
        var serverSession = new ServerSession
        {
            ServerId = Id,
            Username = _username
        };

        sessionManager.SetSession(serverSession);
    }

    public bool HasJoined = false;
}